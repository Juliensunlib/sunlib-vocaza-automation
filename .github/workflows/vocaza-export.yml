name: Export Vocaza Quotidien

on:
  schedule:
    - cron: '0 17 * * *'  # 18h00 heure de Paris (hiver)
  workflow_dispatch:  # Permet test manuel

jobs:
  export-to-vocaza:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install pyairtable paramiko
      
      - name: Create export script
        run: |
          cat > export_vocaza.py << 'SCRIPT_END'
          import os
          import csv
          import paramiko
          from datetime import datetime
          from pyairtable import Api
          
          # ============================================
          # CONFIGURATION
          # ============================================
          
          # Airtable
          BASE_ID = "appe55vTZRk6Ssd2w"
          TABLE_ID = "tblcACuSWYttnFQNr"
          VIEW_ID = "viwQn2IYQ5nBuXxkY"
          
          # Field IDs
          FIELD_EMAIL = "fldG47uG3mXq1qGRP"
          FIELD_PRENOM = "fldhxncaPKtHlqqgZ"
          FIELD_NOM = "fldfnBO2Xb6mNgAcq"
          FIELD_TELEPHONE = "fldI86dLP0hkVIaMb"
          FIELD_DATE_CREATION = "fldxygbu165RonF4P"
          FIELD_AGENCE = "fldNY6lBfZQCXYTCa"
          FIELD_STATUT_VOCAZA = "fldEAceKmwRR9we4a"
          FIELD_DATE_ENVOI = "fld8QZLv3tebi4523"
          
          # Statut Vocaza - Option IDs
          OPTION_ENVOYE = "selk5AkrlBwJ2gudt"
          OPTION_ECHEC = "selqdKkqKxe5wAarj"
          
          # SFTP Vocaza
          SFTP_HOST = "sunlib.enquete-en-ligne.com"
          SFTP_PORT = 12360
          SFTP_USERNAME = "SUNLIB-9180113"
          SFTP_PASSWORD = os.environ['SFTP_PASSWORD']
          AIRTABLE_TOKEN = os.environ['AIRTABLE_TOKEN']
          
          # ============================================
          # FONCTIONS
          # ============================================
          
          def format_date(iso_date):
              """Convertit date ISO en DD/MM/YYYY"""
              if not iso_date:
                  return ''
              try:
                  date_obj = datetime.fromisoformat(iso_date.replace('Z', '+00:00'))
                  return date_obj.strftime('%d/%m/%Y')
              except:
                  return ''
          
          def get_agence(field_value):
              """Extrait l'agence (premier Ã©lÃ©ment si liste)"""
              if not field_value:
                  return ''
              if isinstance(field_value, list):
                  return field_value[0] if field_value else ''
              return str(field_value)
          
          # ============================================
          # SCRIPT PRINCIPAL
          # ============================================
          
          print("=" * 60)
          print("ðŸš€ EXPORT VOCAZA - DÃ‰MARRAGE")
          print("=" * 60)
          print(f"Date : {datetime.now().strftime('%d/%m/%Y %H:%M:%S')}")
          print()
          
          # 1. CONNEXION AIRTABLE
          print("ðŸ“Š Connexion Ã  Airtable...")
          api = Api(AIRTABLE_TOKEN)
          table = api.table(BASE_ID, TABLE_ID)
          
          # 2. RÃ‰CUPÃ‰RATION DES CONTACTS
          print("ðŸ“Š RÃ©cupÃ©ration des contacts Ã  exporter...")
          formula = "AND({Statut Vocaza}='', {Email}!='')"
          
          try:
              records = table.all(view=VIEW_ID, formula=formula)
              print(f"âœ… {len(records)} contacts trouvÃ©s")
          except Exception as e:
              print(f"âŒ Erreur Airtable : {e}")
              exit(1)
          
          if len(records) == 0:
              print("â„¹ï¸  Aucun contact Ã  envoyer aujourd'hui")
              print("=" * 60)
              exit(0)
          
          # 3. GÃ‰NÃ‰RATION DU CSV
          print()
          print("ðŸ“ GÃ©nÃ©ration du fichier CSV...")
          
          timestamp = datetime.now().strftime('%Y%m%d')
          filename = f"sunlib_contacts_{timestamp}.csv"
          temp_file = f"/tmp/{filename}"
          
          record_ids = []
          
          try:
              with open(temp_file, 'w', encoding='utf-8', newline='') as csvfile:
                  writer = csv.writer(csvfile, delimiter=';', quoting=csv.QUOTE_MINIMAL)
                  
                  # En-tÃªtes (minuscules, sans accents - format Vocaza)
                  writer.writerow(['email', 'prenom', 'nom', 'telephone', 'date_inscription', 'agence'])
                  
                  # DonnÃ©es
                  for record in records:
                      fields = record['fields']
                      
                      writer.writerow([
                          fields.get(FIELD_EMAIL, ''),
                          fields.get(FIELD_PRENOM, ''),
                          fields.get(FIELD_NOM, ''),
                          fields.get(FIELD_TELEPHONE, ''),
                          format_date(fields.get(FIELD_DATE_CREATION)),
                          get_agence(fields.get(FIELD_AGENCE))
                      ])
                      
                      record_ids.append(record['id'])
              
              # VÃ©rifier la taille du fichier
              file_size = os.path.getsize(temp_file)
              print(f"âœ… CSV gÃ©nÃ©rÃ© : {filename}")
              print(f"   Lignes : {len(records)} contacts")
              print(f"   Taille : {file_size} octets")
              print(f"   Encodage : UTF-8")
              
          except Exception as e:
              print(f"âŒ Erreur gÃ©nÃ©ration CSV : {e}")
              exit(1)
          
          # 4. UPLOAD SFTP
          print()
          print("ðŸ“¤ Upload SFTP vers Vocaza...")
          print(f"   Serveur : {SFTP_HOST}:{SFTP_PORT}")
          
          upload_success = False
          
          try:
              # Connexion SFTP
              transport = paramiko.Transport((SFTP_HOST, SFTP_PORT))
              transport.connect(username=SFTP_USERNAME, password=SFTP_PASSWORD)
              sftp = paramiko.SFTPClient.from_transport(transport)
              
              # Upload
              sftp.put(temp_file, f"/{filename}")
              
              # VÃ©rification
              remote_size = sftp.stat(f"/{filename}").st_size
              local_size = os.path.getsize(temp_file)
              
              if remote_size == local_size:
                  print(f"âœ… Fichier uploadÃ© avec succÃ¨s !")
                  print(f"   Taille locale : {local_size} octets")
                  print(f"   Taille distante : {remote_size} octets")
                  upload_success = True
              else:
                  print(f"âŒ Erreur : tailles diffÃ©rentes")
                  print(f"   Local : {local_size} octets")
                  print(f"   Distant : {remote_size} octets")
              
              sftp.close()
              transport.close()
              
          except Exception as e:
              print(f"âŒ Erreur SFTP : {e}")
              import traceback
              print(traceback.format_exc())
          
          finally:
              # Nettoyer le fichier temporaire
              if os.path.exists(temp_file):
                  os.remove(temp_file)
          
          # 5. MISE Ã€ JOUR AIRTABLE
          print()
          print("ðŸ”„ Mise Ã  jour Airtable...")
          
          today = datetime.now().strftime('%Y-%m-%d')
          batch_size = 10
          total_updated = 0
          
          try:
              for i in range(0, len(record_ids), batch_size):
                  batch = record_ids[i:i+batch_size]
                  
                  updates = []
                  for record_id in batch:
                      if upload_success:
                          # SuccÃ¨s : Statut "EnvoyÃ©" + Date
                          updates.append({
                              'id': record_id,
                              'fields': {
                                  FIELD_STATUT_VOCAZA: OPTION_ENVOYE,
                                  FIELD_DATE_ENVOI: today
                              }
                          })
                      else:
                          # Ã‰chec : Statut "Echec" uniquement
                          updates.append({
                              'id': record_id,
                              'fields': {
                                  FIELD_STATUT_VOCAZA: OPTION_ECHEC
                              }
                          })
                  
                  table.batch_update(updates)
                  total_updated += len(updates)
                  print(f"   âœ… {total_updated}/{len(record_ids)} contacts mis Ã  jour")
              
              print(f"âœ… Mise Ã  jour Airtable terminÃ©e")
              
          except Exception as e:
              print(f"âŒ Erreur mise Ã  jour Airtable : {e}")
          
          # 6. RÃ‰SUMÃ‰ FINAL
          print()
          print("=" * 60)
          print("ðŸ“Š RÃ‰SUMÃ‰ DE L'EXPORT")
          print("=" * 60)
          print(f"Contacts traitÃ©s    : {len(records)}")
          print(f"Fichier gÃ©nÃ©rÃ©      : {filename}")
          print(f"Upload SFTP         : {'âœ… SuccÃ¨s' if upload_success else 'âŒ Ã‰chec'}")
          print(f"Statut Airtable     : {'EnvoyÃ©' if upload_success else 'Echec'}")
          print(f"Heure de fin        : {datetime.now().strftime('%d/%m/%Y %H:%M:%S')}")
          print("=" * 60)
          
          # Code de sortie
          exit(0 if upload_success else 1)
          SCRIPT_END
      
      - name: Run export script
        env:
          AIRTABLE_TOKEN: ${{ secrets.AIRTABLE_TOKEN }}
          SFTP_PASSWORD: ${{ secrets.SFTP_PASSWORD }}
        run: python export_vocaza.py
