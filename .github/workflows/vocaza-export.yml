name: Export Vocaza Quotidien

on:
  schedule:
    - cron: '0 17 * * *'
  workflow_dispatch:

jobs:
  export-to-vocaza:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install pyairtable paramiko
      
      - name: Create Python script
        run: |
          cat > export_vocaza.py << 'SCRIPT_END'
          import os
          import csv
          import paramiko
          from datetime import datetime
          from pyairtable import Api
          from io import StringIO
          
          # Configuration
          BASE_ID = "appe55vTZRk6Ssd2w"
          TABLE_ID = "tblcACuSWYttnFQNr"
          VIEW_ID = "viwQn2IYQ5nBuXxkY"
          
          # Field IDs
          FIELD_EMAIL = "fldG47uG3mXq1qGRP"
          FIELD_PRENOM = "fldhxncaPKtHlqqgZ"
          FIELD_NOM = "fldfnBO2Xb6mNgAcq"
          FIELD_TELEPHONE = "fldI86dLP0hkVIaMb"
          FIELD_DATE_CREATION = "fldxygbu165RonF4P"
          FIELD_AGENCE = "fldNY6lBfZQCXYTCa"
          FIELD_STATUT_VOCAZA = "fldEAceKmwRR9we4a"
          FIELD_DATE_ENVOI = "fld8QZLv3tebi4523"
          
          # Option IDs pour Statut Vocaza
          OPTION_ENVOYE = "selk5AkrlBwJ2gudt"
          OPTION_ECHEC = "selqdKkqKxe5wAarj"
          
          # SFTP Configuration
          SFTP_HOST = "sunlib.enquete-en-ligne.com"
          SFTP_PORT = 12360
          SFTP_USERNAME = "SUNLIB-9180113"
          SFTP_PASSWORD = os.environ['SFTP_PASSWORD']
          
          print("ðŸš€ DÃ©but de l'export Vocaza...")
          
          # 1. Connexion Airtable
          api = Api(os.environ['AIRTABLE_TOKEN'])
          table = api.table(BASE_ID, TABLE_ID)
          
          print("ðŸ“Š RÃ©cupÃ©ration des contacts Airtable...")
          
          # RÃ©cupÃ©rer les records de la vue avec filtre
          formula = "AND({Statut Vocaza}='', {Email}!='')"
          records = table.all(view=VIEW_ID, formula=formula)
          
          print(f"âœ… {len(records)} contacts trouvÃ©s")
          
          if len(records) == 0:
              print("â„¹ï¸ Aucun contact Ã  envoyer aujourd'hui")
              exit(0)
          
          # 2. GÃ©nÃ©rer le CSV
          print("ðŸ“ GÃ©nÃ©ration du fichier CSV...")
          
          csv_output = StringIO()
          csv_writer = csv.writer(csv_output, delimiter=';', quoting=csv.QUOTE_MINIMAL)
          
          # En-tÃªtes
          csv_writer.writerow(['E-mail', 'PrÃ©nom', 'Nom', 'TÃ©lÃ©phone', 'Date_inscription', 'Agence'])
          
          # DonnÃ©es
