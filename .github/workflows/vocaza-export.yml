name: Export Vocaza Quotidien

on:
  schedule:
    - cron: '0 17 * * *'  # 18h00 heure de Paris (hiver)
  workflow_dispatch:  # Permet test manuel

jobs:
  export-to-vocaza:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install pyairtable paramiko
      
      - name: Create export script
        run: |
          cat > export_vocaza.py << 'SCRIPT_END'
          import os
          import csv
          import paramiko
          from datetime import datetime
          from pyairtable import Api
          
          # ============================================
          # CONFIGURATION
          # ============================================
          
          # Airtable
          BASE_ID = "appe55vTZRk6Ssd2w"
          TABLE_ID = "tblcACuSWYttnFQNr"
          VIEW_ID = "viwQn2IYQ5nBuXxkY"
          
          # Noms de colonnes Airtable (pas Field IDs)
          COL_PDL = "NÂ° de PDL"
          COL_NOM = "Nom"
          COL_PRENOM = "Prenom"
          COL_NOM_ENTREPRISE = "Nom de l'entreprise"
          COL_CIVILITE = "CivilitÃ© AbonnÃ© 1"
          COL_EMAIL = "Email"
          COL_INSTALLATEUR = "Nom de l'entreprise (from Installateur )"
          COL_CONFIG_CLIENT = "Champs IA Config client"
          
          # Tracking
          COL_STATUT_VOCAZA = "Statut Vocaza"
          COL_DATE_ENVOI = "Date d'envoi Vocaza"
          
          # SFTP Vocaza
          SFTP_HOST = "sunlib.enquete-en-ligne.com"
          SFTP_PORT = 12360
          SFTP_USERNAME = "SUNLIB-9180113"
          SFTP_PASSWORD = os.environ['SFTP_PASSWORD']
          AIRTABLE_TOKEN = os.environ['AIRTABLE_TOKEN']
          
          # ============================================
          # FONCTIONS
          # ============================================
          
          def get_field_value(fields, field_name, default=''):
              """RÃ©cupÃ¨re la valeur d'un champ en gÃ©rant les listes"""
              value = fields.get(field_name, default)
              if isinstance(value, list):
                  return value[0] if value else default
              return value if value else default
          
          # ============================================
          # SCRIPT PRINCIPAL
          # ============================================
          
          print("=" * 60)
          print("ðŸš€ EXPORT VOCAZA - DÃ‰MARRAGE")
          print("=" * 60)
          print(f"Date : {datetime.now().strftime('%d/%m/%Y %H:%M:%S')}")
          print()
          
          # 1. CONNEXION AIRTABLE
          print("ðŸ“Š Connexion Ã  Airtable...")
          api = Api(AIRTABLE_TOKEN)
          table = api.table(BASE_ID, TABLE_ID)
          
          # 2. RÃ‰CUPÃ‰RATION DES CONTACTS
          print("ðŸ“Š RÃ©cupÃ©ration des contacts Ã  exporter...")
          formula = f"AND({{{COL_STATUT_VOCAZA}}}='', {{{COL_EMAIL}}}!='')"
          
          try:
              records = table.all(view=VIEW_ID, formula=formula)
              print(f"âœ… {len(records)} contacts trouvÃ©s")
          except Exception as e:
              print(f"âŒ Erreur Airtable : {e}")
              exit(1)
          
          if len(records) == 0:
              print("â„¹ï¸  Aucun contact Ã  envoyer aujourd'hui")
              print("=" * 60)
              exit(0)
          
          # 3. GÃ‰NÃ‰RATION DU CSV
          print()
          print("ðŸ“ GÃ©nÃ©ration du fichier CSV...")
          
          timestamp = datetime.now().strftime('%Y%m%d')
          filename = f"sunlib_contacts_{timestamp}.csv"
          temp_file = f"/tmp/{filename}"
          
          record_ids = []
          
          try:
              with open(temp_file, 'w', encoding='utf-8', newline='') as csvfile:
                  # IMPORTANT : SÃ©parateur = POINT-VIRGULE (format Vocaza)
                  writer = csv.writer(csvfile, delimiter=';', quoting=csv.QUOTE_MINIMAL)
                  
                  # En-tÃªtes - 8 colonnes dans l'ordre exact
                  writer.writerow([
                      'NÂ° de PDL',
                      'Nom',
                      'Prenom',
                      'Nom de l\'entreprise',
                      'CivilitÃ© AbonnÃ© 1',
                      'Email',
                      'Installateur',
                      'Champs IA Config client'
                  ])
                  
                  # DonnÃ©es
                  for record in records:
                      fields = record['fields']
                      
                      writer.writerow([
                          get_field_value(fields, COL_PDL),
                          get_field_value(fields, COL_NOM),
                          get_field_value(fields, COL_PRENOM),
                          get_field_value(fields, COL_NOM_ENTREPRISE),
                          get_field_value(fields, COL_CIVILITE),
                          get_field_value(fields, COL_EMAIL),
                          get_field_value(fields, COL_INSTALLATEUR),
                          get_field_value(fields, COL_CONFIG_CLIENT)
                      ])
                      
                      record_ids.append(record['id'])
              
              # VÃ©rifier la taille du fichier
              file_size = os.path.getsize(temp_file)
              print(f"âœ… CSV gÃ©nÃ©rÃ© : {filename}")
              print(f"   Lignes : {len(records)} contacts")
              print(f"   Taille : {file_size} octets")
              print(f"   Encodage : UTF-8")
              print(f"   SÃ©parateur : point-virgule (;)")
              
          except Exception as e:
              print(f"âŒ Erreur gÃ©nÃ©ration CSV : {e}")
              exit(1)
          
          # 4. UPLOAD SFTP
          print()
          print("ðŸ“¤ Upload SFTP vers Vocaza...")
          print(f"   Serveur : {SFTP_HOST}:{SFTP_PORT}")
          
          upload_success = False
          
          try:
              # Connexion SFTP
              transport = paramiko.Transport((SFTP_HOST, SFTP_PORT))
              transport.connect(username=SFTP_USERNAME, password=SFTP_PASSWORD)
              sftp = paramiko.SFTPClient.from_transport(transport)
              
              # Upload
