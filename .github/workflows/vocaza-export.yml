name: Export Vocaza Quotidien

on:
  schedule:
    # Tous les jours √† 18h00 (heure de Paris = 17h00 UTC en hiver, 16h00 UTC en √©t√©)
    - cron: '0 17 * * *'
  workflow_dispatch: # Permet de tester manuellement

jobs:
  export-to-vocaza:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install pyairtable paramiko
      
      - name: Export and Upload to Vocaza
        env:
          AIRTABLE_TOKEN: ${{ secrets.AIRTABLE_TOKEN }}
          SFTP_PASSWORD: ${{ secrets.SFTP_PASSWORD }}
        run: |
          python - <<'EOF'
          import os
          import csv
          import paramiko
          from datetime import datetime
          from pyairtable import Api
          from io import StringIO
          
          # Configuration
          BASE_ID = "appe55vTZRk6Ssd2w"
          TABLE_ID = "tblcACuSWYttnFQNr"
          VIEW_ID = "viwQn2IYQ5nBuXxkY"
          
          # Field IDs
          FIELD_EMAIL = "fldG47uG3mXq1qGRP"
          FIELD_PRENOM = "fldhxncaPKtHlqqgZ"
          FIELD_NOM = "fldfnBO2Xb6mNgAcq"
          FIELD_TELEPHONE = "fldI86dLP0hkVIaMb"
          FIELD_DATE_CREATION = "fldxygbu165RonF4P"
          FIELD_AGENCE = "fldNY6lBfZQCXYTCa"
          FIELD_STATUT_VOCAZA = "fldEAceKmwRR9we4a"
          FIELD_DATE_ENVOI = "fld8QZLv3tebi4523"
          
          # Option IDs pour Statut Vocaza
          OPTION_ENVOYE = "selk5AkrlBwJ2gudt"
          OPTION_ECHEC = "selqdKkqKxe5wAarj"
          
          # SFTP Configuration
          SFTP_HOST = "sunlib.enquete-en-ligne.com"
          SFTP_PORT = 12360
          SFTP_USERNAME = "SUNLIB-9180113"
          SFTP_PASSWORD = os.environ['SFTP_PASSWORD']
          
          print("üöÄ D√©but de l'export Vocaza...")
          
          # 1. Connexion Airtable
          api = Api(os.environ['AIRTABLE_TOKEN'])
          table = api.table(BASE_ID, TABLE_ID)
          
          print("üìä R√©cup√©ration des contacts Airtable...")
          
          # R√©cup√©rer les records de la vue avec filtre
          formula = "AND({Statut Vocaza}='', {Email}!='')"
          records = table.all(view=VIEW_ID, formula=formula)
          
          print(f"‚úÖ {len(records)} contacts trouv√©s")
          
          if len(records) == 0:
              print("‚ÑπÔ∏è Aucun contact √† envoyer aujourd'hui")
              exit(0)
          
          # 2. G√©n√©rer le CSV
          print("üìù G√©n√©ration du fichier CSV...")
          
          csv_output = StringIO()
          csv_writer = csv.writer(csv_output, delimiter=';', quoting=csv.QUOTE_MINIMAL)
          
          # En-t√™tes
          csv_writer.writerow(['E-mail', 'Pr√©nom', 'Nom', 'T√©l√©phone', 'Date_inscription', 'Agence'])
          
          # Donn√©es
          record_ids = []
          for record in records:
              fields = record['fields']
              
              # Formatage date (ISO -> DD/MM/YYYY)
              date_inscription = ''
              if FIELD_DATE_CREATION in fields:
                  date_obj = datetime.fromisoformat(fields[FIELD_DATE_CREATION].replace('Z', '+00:00'))