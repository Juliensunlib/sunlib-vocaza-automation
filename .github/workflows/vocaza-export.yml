name: Export Vocaza Quotidien

on:
  schedule:
    - cron: '0 17 * * *'
  workflow_dispatch:

jobs:
  export-to-vocaza:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install pyairtable paramiko
      
      - name: Create export script
        run: |
          cat > export_vocaza.py << 'SCRIPT_END'
          import os
          import csv
          import paramiko
          from datetime import datetime
          from pyairtable import Api
          
          BASE_ID = "appe55vTZRk6Ssd2w"
          TABLE_ID = "tblcACuSWYttnFQNr"
          VIEW_ID = "viwQn2IYQ5nBuXxkY"
          
          COL_PDL = "NÂ° de PDL"
          COL_NOM = "Nom"
          COL_PRENOM = "Prenom"
          COL_NOM_ENTREPRISE = "Nom de l'entreprise"
          COL_CIVILITE = "CivilitÃ© AbonnÃ© 1"
          COL_EMAIL = "Email"
          COL_INSTALLATEUR = "Nom de l'entreprise (from Installateur )"
          COL_CONFIG_CLIENT = "Champs IA Config client"
          COL_STATUT_VOCAZA = "Statut Vocaza"
          COL_DATE_ENVOI = "Date d'envoi Vocaza"
          
          SFTP_HOST = "sunlib.enquete-en-ligne.com"
          SFTP_PORT = 12360
          SFTP_USERNAME = "SUNLIB-9180113"
          SFTP_PASSWORD = os.environ['SFTP_PASSWORD']
          AIRTABLE_TOKEN = os.environ['AIRTABLE_TOKEN']
          
          def get_field_value(fields, field_name, default=''):
              value = fields.get(field_name, default)
              if isinstance(value, list):
                  return value[0] if value else default
              return value if value else default
          
          print("=" * 60)
          print("ðŸš€ EXPORT VOCAZA - DÃ‰MARRAGE")
          print("=" * 60)
          print(f"Date : {datetime.now().strftime('%d/%m/%Y %H:%M:%S')}")
          print()
          
          print("ðŸ“Š Connexion Ã  Airtable...")
          api = Api(AIRTABLE_TOKEN)
          table = api.table(BASE_ID, TABLE_ID)
          
          print("ðŸ“Š RÃ©cupÃ©ration des contacts Ã  exporter...")
          formula = f"AND({{{COL_STATUT_VOCAZA}}}='', {{{COL_EMAIL}}}!='')"
          
          try:
              records = table.all(view=VIEW_ID, formula=formula)
              print(f"âœ… {len(records)} contacts trouvÃ©s")
          except Exception as e:
              print(f"âŒ Erreur Airtable : {e}")
              exit(1)
          
          if len(records) == 0:
              print("â„¹ï¸  Aucun contact Ã  envoyer aujourd'hui")
              print("=" * 60)
              exit(0)
          
          print()
          print("ðŸ“ GÃ©nÃ©ration du fichier CSV...")
          
          timestamp = datetime.now().strftime('%Y%m%d')
          filename = f"sunlib_contacts_{timestamp}.csv"
          temp_file = f"/tmp/{filename}"
          
          record_ids = []
          
          try:
              with open(temp_file, 'w', encoding='cp1252', newline='') as csvfile:
                  writer = csv.writer(csvfile, delimiter=';', quoting=csv.QUOTE_MINIMAL)
                  
                  writer.writerow([
                      'NÂ° de PDL',
                      'Nom',
                      'Prenom',
                      'Nom de l\'entreprise',
                      'CivilitÃ© AbonnÃ© 1',
                      'Email',
                      'Installateur',
                      'Champs IA Config client'
                  ])
                  
                  for record in records:
                      fields = record['fields']
                      
                      writer.writerow([
                          get_field_value(fields, COL_PDL),
                          get_field_value(fields, COL_NOM),
                          get_field_value(fields, COL_PRENOM),
                          get_field_value(fields, COL_NOM_ENTREPRISE),
                          get_field_value(fields, COL_CIVILITE),
                          get_field_value(fields, COL_EMAIL),
                          get_field_value(fields, COL_INSTALLATEUR),
                          get_field_value(fields, COL_CONFIG_CLIENT)
                      ])
                      
                      record_ids.append(record['id'])
              
              file_size = os.path.getsize(temp_file)
              print(f"âœ… CSV gÃ©nÃ©rÃ© : {filename}")
              print(f"   Lignes : {len(records)} contacts")
              print(f"   Taille : {file_size} octets")
              
          except Exception as e:
              print(f"âŒ Erreur gÃ©nÃ©ration CSV : {e}")
              exit(1)
          
          print()
          print("ðŸ“¤ Upload SFTP vers Vocaza...")
          print(f"   Serveur : {SFTP_HOST}:{SFTP_PORT}")
          
          upload_success = False
          
          try:
              transport = paramiko.Transport((SFTP_HOST, SFTP_PORT))
              transport.connect(username=SFTP_USERNAME, password=SFTP_PASSWORD)
              sftp = paramiko.SFTPClient.from_transport(transport)
              
              sftp.put(temp_file, f"/{filename}")
              
              remote_size = sftp.stat(f"/{filename}").st_size
              local_size = os.path.getsize(temp_file)
              
              if remote_size == local_size:
                  print(f"âœ… Fichier uploadÃ© avec succÃ¨s !")
                  print(f"   Taille locale : {local_size} octets")
                  print(f"   Taille distante : {remote_size} octets")
                  upload_success = True
              else:
                  print(f"âŒ Erreur : tailles diffÃ©rentes")
              
              sftp.close()
              transport.close()
              
          except Exception as e:
              print(f"âŒ Erreur SFTP : {e}")
              import traceback
              print(traceback.format_exc())
          
          finally:
              if os.path.exists(temp_file):
                  os.remove(temp_file)
          
          print()
          print("ðŸ”„ Mise Ã  jour Airtable...")
          
          today = datetime.now().strftime('%Y-%m-%d')
          batch_size = 10
          total_updated = 0
          
          try:
              for i in range(0, len(record_ids), batch_size):
                  batch = record_ids[i:i+batch_size]
                  
                  updates = []
                  for record_id in batch:
                      if upload_success:
                          updates.append({
                              'id': record_id,
                              'fields': {
                                  COL_STATUT_VOCAZA: 'EnvoyÃ©',
                                  COL_DATE_ENVOI: today
                              }
                          })
                      else:
                          updates.append({
                              'id': record_id,
                              'fields': {
                                  COL_STATUT_VOCAZA: 'Echec'
                              }
                          })
                  
                  table.batch_update(updates)
                  total_updated += len(updates)
                  print(f"   âœ… {total_updated}/{len(record_ids)} contacts mis Ã  jour")
              
              print(f"âœ… Mise Ã  jour Airtable terminÃ©e")
              
          except Exception as e:
              print(f"âŒ Erreur mise Ã  jour Airtable : {e}")
          
          print()
          print("=" * 60)
          print("ðŸ“Š RÃ‰SUMÃ‰ DE L'EXPORT")
          print("=" * 60)
          print(f"Contacts traitÃ©s    : {len(records)}")
          print(f"Fichier gÃ©nÃ©rÃ©      : {filename}")
          print(f"Upload SFTP         : {'âœ… SuccÃ¨s' if upload_success else 'âŒ Ã‰chec'}")
          print(f"Statut Airtable     : {'EnvoyÃ©' if upload_success else 'Echec'}")
          print(f"Heure de fin        : {datetime.now().strftime('%d/%m/%Y %H:%M:%S')}")
          print("=" * 60)
          
          exit(0 if upload_success else 1)
          SCRIPT_END
      
      - name: Run export script
        env:
          AIRTABLE_TOKEN: ${{ secrets.AIRTABLE_TOKEN }}
          SFTP_PASSWORD: ${{ secrets.SFTP_PASSWORD }}
        run: python export_vocaza.py
