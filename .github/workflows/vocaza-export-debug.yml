name: Export Vocaza Debug - ULTRA DÃ‰TAILLÃ‰

on:
  workflow_dispatch:

jobs:
  export-to-vocaza:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install pyairtable paramiko
      
      - name: Create export script
        run: |
          cat > export_vocaza.py << 'SCRIPT_END'
          import os
          import csv
          import paramiko
          import binascii
          from datetime import datetime
          from pyairtable import Api
          
          BASE_ID = "appe55vTZRk6Ssd2w"
          TABLE_ID = "tblcACuSWYttnFQNr"
          VIEW_ID = "viwQn2IYQ5nBuXxkY"
          
          COL_PDL = "NÂ° de PDL"
          COL_NOM = "Nom"
          COL_PRENOM = "Prenom"
          COL_NOM_ENTREPRISE = "Nom de l'entreprise"
          COL_CIVILITE = "CivilitÃ© AbonnÃ© 1"
          COL_EMAIL = "Email"
          COL_INSTALLATEUR = "Nom de l'entreprise (from Installateur )"
          COL_CONFIG_CLIENT = "Champs IA Config client"
          COL_STATUT_VOCAZA = "Statut Vocaza"
          COL_DATE_ENVOI = "Date d'envoi Vocaza"
          
          SFTP_HOST = "sunlib.enquete-en-ligne.com"
          SFTP_PORT = 12360
          SFTP_USERNAME = "SUNLIB-9180113"
          SFTP_PASSWORD = os.environ['SFTP_PASSWORD']
          AIRTABLE_TOKEN = os.environ['AIRTABLE_TOKEN']
          
          def get_field_value(fields, field_name, default=''):
              value = fields.get(field_name, default)
              if isinstance(value, list):
                  return value[0] if value else default
              return value if value else default
          
          print("=" * 80)
          print("ðŸš€ EXPORT VOCAZA - DEBUG ULTRA DÃ‰TAILLÃ‰")
          print("=" * 80)
          print(f"Date : {datetime.now().strftime('%d/%m/%Y %H:%M:%S')}")
          print()
          
          # 1. CONNEXION AIRTABLE
          print("ðŸ“Š Connexion Ã  Airtable...")
          api = Api(AIRTABLE_TOKEN)
          table = api.table(BASE_ID, TABLE_ID)
          
          # 2. RÃ‰CUPÃ‰RATION DES CONTACTS
          print("ðŸ“Š RÃ©cupÃ©ration des contacts Ã  exporter...")
          formula = f"AND({{{COL_STATUT_VOCAZA}}}='', {{{COL_EMAIL}}}!='')"
          
          try:
              records = table.all(view=VIEW_ID, formula=formula)
              print(f"âœ… {len(records)} contacts trouvÃ©s")
          except Exception as e:
              print(f"âŒ Erreur Airtable : {e}")
              exit(1)
          
          if len(records) == 0:
              print("â„¹ï¸  Aucun contact Ã  envoyer aujourd'hui")
              exit(0)
          
          # 3. AFFICHAGE DÃ‰TAILLÃ‰ DES DONNÃ‰ES
          print()
          print("=" * 80)
          print("ðŸ” DONNÃ‰ES AIRTABLE - ANALYSE DÃ‰TAILLÃ‰E")
          print("=" * 80)
          
          for i, record in enumerate(records):
              fields = record['fields']
              print(f"\nðŸ“‹ Contact {i+1}/{len(records)} :")
              print(f"   Record ID    : {record['id']}")
              print(f"   PDL          : '{get_field_value(fields, COL_PDL)}' (type: {type(get_field_value(fields, COL_PDL)).__name__}, len: {len(str(get_field_value(fields, COL_PDL)))})")
              print(f"   Nom          : '{get_field_value(fields, COL_NOM)}' (type: {type(get_field_value(fields, COL_NOM)).__name__}, len: {len(str(get_field_value(fields, COL_NOM)))})")
              print(f"   Prenom       : '{get_field_value(fields, COL_PRENOM)}' (type: {type(get_field_value(fields, COL_PRENOM)).__name__}, len: {len(str(get_field_value(fields, COL_PRENOM)))})")
              print(f"   Entreprise   : '{get_field_value(fields, COL_NOM_ENTREPRISE)}' (type: {type(get_field_value(fields, COL_NOM_ENTREPRISE)).__name__}, len: {len(str(get_field_value(fields, COL_NOM_ENTREPRISE)))})")
              print(f"   CivilitÃ©     : '{get_field_value(fields, COL_CIVILITE)}' (type: {type(get_field_value(fields, COL_CIVILITE)).__name__}, len: {len(str(get_field_value(fields, COL_CIVILITE)))})")
              print(f"   Email        : '{get_field_value(fields, COL_EMAIL)}' (type: {type(get_field_value(fields, COL_EMAIL)).__name__}, len: {len(str(get_field_value(fields, COL_EMAIL)))})")
              print(f"   Installateur : '{get_field_value(fields, COL_INSTALLATEUR)}' (type: {type(get_field_value(fields, COL_INSTALLATEUR)).__name__}, len: {len(str(get_field_value(fields, COL_INSTALLATEUR)))})")
              print(f"   Config       : '{get_field_value(fields, COL_CONFIG_CLIENT)}' (type: {type(get_field_value(fields, COL_CONFIG_CLIENT)).__name__}, len: {len(str(get_field_value(fields, COL_CONFIG_CLIENT)))})")
          
          print("\n" + "=" * 80)
          
          # 4. GÃ‰NÃ‰RATION DU CSV
          print()
          print("ðŸ“ GÃ©nÃ©ration du fichier CSV...")
          
          timestamp = datetime.now().strftime('%Y%m%d')
          filename = f"sunlib_contacts_{timestamp}.csv"
          temp_file = f"/tmp/{filename}"
          
          record_ids = []
          
          try:
              with open(temp_file, 'w', encoding='cp1252', errors='replace', newline='') as csvfile:
                  writer = csv.writer(csvfile, delimiter=';', quoting=csv.QUOTE_MINIMAL)
                  
                  # En-tÃªtes
                  headers = [
                      'NÂ° de PDL',
                      'Nom',
                      'Prenom',
                      'Nom de l\'entreprise',
                      'CivilitÃ© AbonnÃ© 1',
                      'Email',
                      'Installateur',
                      'Champs IA Config client'
                  ]
                  writer.writerow(headers)
                  
                  # DonnÃ©es
                  for record in records:
                      fields = record['fields']
                      
                      writer.writerow([
                          get_field_value(fields, COL_PDL),
                          get_field_value(fields, COL_NOM),
                          get_field_value(fields, COL_PRENOM),
                          get_field_value(fields, COL_NOM_ENTREPRISE),
                          get_field_value(fields, COL_CIVILITE),
                          get_field_value(fields, COL_EMAIL),
                          get_field_value(fields, COL_INSTALLATEUR),
                          get_field_value(fields, COL_CONFIG_CLIENT)
                      ])
                      
                      record_ids.append(record['id'])
              
              file_size = os.path.getsize(temp_file)
              print(f"âœ… CSV gÃ©nÃ©rÃ© : {filename}")
              print(f"   Taille : {file_size} octets")
              print(f"   Encodage : ANSI (cp1252)")
              
          except Exception as e:
              print(f"âŒ Erreur gÃ©nÃ©ration CSV : {e}")
              import traceback
              print(traceback.format_exc())
              exit(1)
          
          # 5. ANALYSE DU FICHIER GÃ‰NÃ‰RÃ‰
          print()
          print("=" * 80)
          print("ðŸ” ANALYSE DU FICHIER CSV GÃ‰NÃ‰RÃ‰")
          print("=" * 80)
          
          # Lire le contenu complet
          with open(temp_file, 'rb') as f:
              raw_content = f.read()
          
          print(f"\nðŸ“Š Statistiques du fichier :")
          print(f"   Taille totale : {len(raw_content)} octets")
          print(f"   Nombre de lignes : {raw_content.count(b'\\n') + 1}")
          print(f"   Nombre de ; : {raw_content.count(b';')}")
          
          # Afficher les 500 premiers bytes en hexa
          print(f"\nðŸ”¢ Premiers 500 bytes (hexadÃ©cimal) :")
          hex_dump = binascii.hexlify(raw_content[:500]).decode('ascii')
          for i in range(0, len(hex_dump), 80):
              print(f"   {hex_dump[i:i+80]}")
          
          # Afficher le contenu texte complet
          print(f"\nðŸ“„ Contenu complet du fichier (encodage cp1252) :")
          print("-" * 80)
          try:
              with open(temp_file, 'r', encoding='cp1252') as f:
                  content_lines = f.readlines()
                  for i, line in enumerate(content_lines, 1):
                      print(f"Ligne {i}: {line.rstrip()}")
          except Exception as e:
              print(f"âŒ Erreur lecture : {e}")
          print("-" * 80)
          
          # VÃ©rifier caractÃ¨re par caractÃ¨re de la premiÃ¨re ligne
          print(f"\nðŸ” Analyse caractÃ¨re par caractÃ¨re de l'en-tÃªte :")
          try:
              with open(temp_file, 'r', encoding='cp1252') as f:
                  first_line = f.readline().rstrip()
                  print(f"   Longueur : {len(first_line)} caractÃ¨res")
                  for i, char in enumerate(first_line[:100]):  # Premier 100 caractÃ¨res
                      print(f"   [{i:2d}] '{char}' (ASCII: {ord(char)}, hex: {hex(ord(char))})")
          except Exception as e:
              print(f"âŒ Erreur : {e}")
          
          # VÃ©rifier les fins de ligne
          print(f"\nðŸ” Analyse des fins de ligne :")
          if b'\\r\\n' in raw_content:
              print(f"   âœ… Format Windows (CRLF - \\r\\n)")
          elif b'\\n' in raw_content:
              print(f"   â„¹ï¸  Format Unix (LF - \\n)")
          elif b'\\r' in raw_content:
              print(f"   âš ï¸  Format Mac ancien (CR - \\r)")
          
          print("\n" + "=" * 80)
          
          # 6. TEST DE RELECTURE
          print()
          print("=" * 80)
          print("ðŸ” TEST DE RELECTURE DU CSV")
          print("=" * 80)
          
          try:
              with open(temp_file, 'r', encoding='cp1252', newline='') as csvfile:
                  reader = csv.reader(csvfile, delimiter=';')
                  rows = list(reader)
                  
                  print(f"âœ… Fichier lisible : {len(rows)} lignes trouvÃ©es")
                  print(f"\nðŸ“‹ Structure dÃ©tectÃ©e :")
                  
                  for i, row in enumerate(rows):
                      print(f"   Ligne {i}: {len(row)} colonnes â†’ {row}")
                  
          except Exception as e:
              print(f"âŒ Erreur relecture : {e}")
          
          print("\n" + "=" * 80)
          
          # 7. COPIE POUR TÃ‰LÃ‰CHARGEMENT
          print()
          print("ðŸ’¾ Copie du fichier pour tÃ©lÃ©chargement...")
          
          download_file = f"/tmp/debug_{filename}"
          import shutil
          shutil.copy(temp_file, download_file)
          print(f"âœ… Fichier copiÃ© : {download_file}")
          
          # Afficher le chemin absolu
          print(f"   Chemin absolu : {os.path.abspath(download_file)}")
          
          print()
          print("=" * 80)
          print("âš ï¸  MODE DEBUG : Upload SFTP dÃ©sactivÃ©")
          print("   Le fichier est prÃªt mais non envoyÃ© Ã  Vocaza")
          print("=" * 80)
          
          # Nettoyer
          if os.path.exists(temp_file):
              os.remove(temp_file)
          
          print()
          print("âœ… DEBUG TERMINÃ‰")
          print()
          SCRIPT_END
      
      - name: Run export script
        env:
          AIRTABLE_TOKEN: ${{ secrets.AIRTABLE_TOKEN }}
          SFTP_PASSWORD: ${{ secrets.SFTP_PASSWORD }}
        run: python export_vocaza.py
      
      - name: Upload CSV artifact
        uses: actions/upload-artifact@v3
        with:
          name: vocaza-csv-debug
          path: /tmp/debug_*.csv
          retention-days: 1
